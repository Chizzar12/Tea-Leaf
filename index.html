<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Chat App</title>
	<link rel="stylesheet" href="index.css"/>
</head>
<body>
	<h1>Chat App</h1>
	<div id="chat-messages"></div>
	<input type="text" id="chat-message-input" placeholder="Type your message...">
	<button type="button" id="chat-send-button">Send</button>
	<!-- Firebase scripts -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-analytics.js";
  import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
   apiKey: "<your-api-key>",
       authDomain: "<your-auth-domain>",
       databaseURL: "<your-database-url>",
       projectId: "<your-project-id>",
       storageBucket: "<your-storage-bucket>",
       messagingSenderId: "<your-sender-id>",
       appId: "<your-app-id>",
       measurementId: "<your-measurement-id>"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const database = getDatabase(app);
  
  // Get a reference to the chat messages node
  const chatMessagesRef = ref(database, 'chat-messages');
  
  // Keep track of the latest message key to prevent duplicate messages
  let latestMessageKey = null;
  
  // Listen for new chat messages
  onValue(chatMessagesRef, function(snapshot) {
    const messages = snapshot.val();
    for (const key in messages) {
      if (key !== latestMessageKey) {
        const message = messages[key];
        message.key = key;
        displayChatMessage(message);
        latestMessageKey = key;
      }
    }
  });
  
  // Send a new chat message
  const chatMessageInput = document.getElementById('chat-message-input');
  const chatSendButton = document.getElementById('chat-send-button');
  let replyToKey = null;

  chatSendButton.addEventListener('click', function() {
    const messageText = chatMessageInput.value;
    const message = {
      text: messageText,
      timestamp: Date.now(),
      replyTo: replyToKey // add replyTo field to message object
    };
    push(chatMessagesRef, message);
    chatMessageInput.value = '';
    replyToKey = null; // reset replyToKey
  });
  
  function displayChatMessage(message) {
    const messageText = message.text;
    const messageTimestamp = message.timestamp;
    const messageElement = document.createElement('div');
    messageElement.innerText = messageText + ' - ' + new Date(messageTimestamp).toLocaleString();
    
    // Add reply-to message if it exists
    if (message.replyTo) {
      const replyToMessage = document.createElement('div');
      replyToMessage.innerText = 'Replying to: ' + message.replyTo;
      messageElement.appendChild(replyToMessage);
    }
    
    // Append message element to the chat messages container
    const chatMessagesContainer = document.getElementById('chat-messages');
    chatMessagesContainer.appendChild(messageElement);
  }
</script>
</body>
</html>
